*filter
:INPUT ACCEPT
:FORWARD DROP
:OUTPUT ACCEPT

# 自ホストからのアクセスを許可
-A INPUT -i lo -j ACCEPT

# プライベートIPアドレスからのアクセスを破棄
#-A INPUT -s 10.0.0.0/8 -j DROP
#-A INPUT -s 172.16.0.0/12 -j DROP
#-A INPUT -s 192.168.0.0/16 -j DROP

# 全ホスト(ブロードキャストアドレス、マルチキャストアドレス)宛パケットはログを記録せずに破棄
-A INPUT -d 255.255.255.255 -j DROP
-A INPUT -d 224.0.0.1 -j DROP

# ESTABLISHEDもしくはRELATEDであれば通信を許可
-A INPUT -m state --state ESTABLISHED,RELATED -j ACCEPT

# 利用するサービスの接続許可
# http(s)
-A INPUT -m state --state NEW -m tcp -p tcp --dport 80 -j ACCEPT
-A INPUT -m state --state NEW -m tcp -p tcp --dport 443 -j ACCEPT
# ssh
-A INPUT -m state --state NEW -m tcp -p tcp --dport <%= node.default.dev_tools.ssh_port %> -j ACCEPT

# SSHのブルートフォースアタック対策
-A INPUT -p tcp --dport <%= node.default.dev_tools.ssh_port %> -m state --state NEW -m recent --set --name SSH
-A INPUT -p tcp --dport <%= node.default.dev_tools.ssh_port %> -m state --state NEW -m recent --update --seconds 60 --hitcount 8 --rttl --name SSH -j DROP

# 上記のルールにマッチしなかったアクセスはログを記録して破棄
-A INPUT -m limit --limit 1/s -j LOG --log-prefix "[IPTABLES INPUT]: "
-A INPUT -j DROP
-A FORWARD -m limit --limit 1/s -j LOG --log-prefix "[IPTABLES FORWARD]: "
-A FORWARD -j DROP

COMMIT
